// Known Exploited Vulnerability (KEV) catalog
//https://www.cisa.gov/known-exploited-vulnerabilities
//CISA vedligeholder KEV-kataloget, som er den autoritative kilde til sårbarheder, der er blevet udnyttet i det fri.

//INDLÆSER csv FILEN FRA https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv
let KEV=
externaldata(cveID: string, vendorProject: string, product: string, vulnerabilityName: string, dateAdded: datetime, shortDescription: string, requiredAction: string, dueDate: datetime, knownRansomwareCampaignUse:string,notes:string)
[
h@'https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv'
]
with(format='csv',ignorefirstrecord=true);

// kql  tabel DeviceTvmSoftwareVulnerabilities og join med CSV
DeviceTvmSoftwareVulnerabilities
| where OSPlatform contains "Windows10"or OSPlatform contains "Windows11" 
| project DeviceName, OSPlatform, cveID=CveId
| join kind=inner KEV on cveID
| where knownRansomwareCampaignUse =~ "Known"
| summarize ['Vulnerabilities']=make_set(cveID) by DeviceName,product,vulnerabilityName,shortDescription,dateAdded,requiredAction,knownRansomwareCampaignUse
| sort by knownRansomwareCampaignUse asc 
